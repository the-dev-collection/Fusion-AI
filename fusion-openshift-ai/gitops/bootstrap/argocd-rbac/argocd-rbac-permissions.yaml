---
apiVersion: batch/v1
kind: Job
metadata:
  name: grant-argocd-rbac-permissions
  namespace: openshift-gitops
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/sync-wave: "-20"
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  template:
    spec:
      serviceAccountName: openshift-gitops-argocd-application-controller
      restartPolicy: Never
      containers:
        - name: grant-permissions
          image: registry.redhat.io/openshift4/ose-cli:latest
          command:
            - /bin/bash
            - -c
            - |
              echo "Granting ArgoCD RBAC permissions..."
              
              # Create ClusterRole for ArgoCD to manage RBAC resources
              oc apply -f - <<EOF
              apiVersion: rbac.authorization.k8s.io/v1
              kind: ClusterRole
              metadata:
                name: argocd-rbac-manager
              rules:
                - apiGroups: [""]
                  resources: ["serviceaccounts"]
                  verbs: ["create", "get", "list", "watch", "update", "patch", "delete"]
                - apiGroups: ["rbac.authorization.k8s.io"]
                  resources: ["clusterroles", "clusterrolebindings"]
                  verbs: ["create", "get", "list", "watch", "update", "patch", "delete"]
              EOF

              # Create ClusterRoleBinding
              oc apply -f - <<EOF
              apiVersion: rbac.authorization.k8s.io/v1
              kind: ClusterRoleBinding
              metadata:
                name: argocd-rbac-manager-binding
              subjects:
                - kind: ServiceAccount
                  name: openshift-gitops-argocd-application-controller
                  namespace: openshift-gitops
              roleRef:
                apiGroup: rbac.authorization.k8s.io
                kind: ClusterRole
                name: argocd-rbac-manager
              EOF

              echo "âœ“ ArgoCD RBAC permissions granted successfully"

# Made with Bob
